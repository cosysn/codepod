# CodePod 系统架构设计

**版本**: v1.0
**日期**: 2026-02-17

## 1. 系统总体架构

### 1.1 架构总览

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    CodePod                                              │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              控制平面 (Control Plane)                              │  │
│  │                                                                                    │  │
│  │  ┌────────────────┐  ┌────────────────┐  ┌──────────────────────────────────────┐ │  │
│  │  │     CLI        │  │     SDK        │  │              Server                   │ │  │
│  │  │  (Node.js)    │  │  (Node.js)    │  │            (Node.js)                 │ │  │
│  │  │                │  │                │  │                                       │ │  │
│  │  │ - 命令行工具   │  │ - REST 客户端  │  │  - HTTP API Server                    │ │  │
│  │  │ - 交互式Shell │  │ - 类型定义     │  │  - 任务调度器                         │ │  │
│  │  │ - 配置文件    │  │ - 认证模块     │  │  - 认证授权                          │ │  │
│  │  └───────┬────────┘  └───────┬────────┘  │  - 资源配额管理                      │ │  │
│  │          │                   │           │  - 审计日志                          │ │  │
│  │          └───────────┬───────┘           └──────────────┬───────────────────────┘ │  │
│  │                      │                                   │                           │  │
│  │                      │              HTTP/HTTPS          │                           │  │
│  │                      └───────────────────────────────────┘                           │  │
│  └──────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                            │
│                                              │ gRPC over TLS (mTLS)                       │
│                                              ▼                                            │
│  ┌──────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              编排平面 (Orchestration Plane)                         │  │
│  │                                                                                    │  │
│  │  ┌───────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                              Runner (Go)                                      │  │  │
│  │  │                                                                               │  │  │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐   │  │  │
│  │  │  │  任务调度器      │  │   Docker 引擎   │  │       存储管理              │   │  │  │
│  │  │  │  - Job Queue   │  │  - 镜像构建     │  │  - 卷管理                  │   │  │  │
│  │  │  │  - 心跳处理    │  │  - 容器生命周期 │  │  - 快照管理                │   │  │  │
│  │  │  │  - 状态机      │  │  - Agent 注入   │  │  - 数据迁移                │   │  │  │
│  │  │  └────────┬────────┘  └────────┬────────┘  └──────────────┬──────────────┘   │  │  │
│  │  │           │                    │                          │                   │  │  │
│  │  │           └────────────────────┼──────────────────────────┘                   │  │  │
│  │  │                                │                                              │  │  │
│  │  │                    ┌────────────┴────────────┐                                  │  │  │
│  │  │                    │      Agent 管理器       │                                  │  │  │
│  │  │                    │  - 版本检测             │                                  │  │  │
│  │  │                    │  - 更新下发             │                                  │  │  │
│  │  │                    │  - 状态监控             │                                  │  │  │
│  │  │                    └─────────────────────────┘                                  │  │  │
│  │  └───────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                    │  │
│  │                              反向隧道 (Reverse Tunnel)                               │  │
│  │                         Runner ──────────────────────► Server                       │  │
│  │                                                                                    │  │
│  └──────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                            │
│                                              │ Docker 操作                                  │
│                                              ▼                                            │
│  ┌──────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              沙盒平面 (Sandbox Plane)                               │  │
│  │                                                                                    │  │
│  │  ┌───────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                     Sandbox Container 1                                       │  │  │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │  │
│  │  │  │                        Agent (Go) - PID 1                               │ │  │  │
│  │  │  │                                                                          │ │  │  │
│  │  │  │  ┌───────────────┐  ┌───────────────┐  ┌─────────────────────────────┐  │ │  │  │
│  │  │  │  │  SSH Server   │  │  进程管理器   │  │       命令执行器            │  │ │  │  │
│  │  │  │  │  - 端口 22   │  │  - PID 1     │  │  - 交互 Shell              │  │ │  │  │
│  │  │  │  │  - 公钥认证  │  │  - 子进程回收 │  │  - Exec 命令               │  │ │  │  │
│  │  │  │  │  - 端口转发  │  │  - 信号转发  │  │  - 管道/重定向             │  │ │  │  │
│  │  │  │  │  - X11 转发  │  │  - 资源限制  │  │  - 会话管理                │  │ │  │  │
│  │  │  │  └───────────────┘  └───────────────┘  └─────────────────────────────┘  │ │  │  │
│  │  │  │                                                                          │ │  │  │
│  │  │  │  ┌───────────────┐  ┌───────────────┐  ┌─────────────────────────────┐  │ │  │  │
│  │  │  │  │   证书代理    │  │   文件管理器   │  │        更新模块            │  │ │  │  │
│  │  │  │  │   (mTLS)     │  │               │  │  - 版本检测                 │  │ │  │  │
│  │  │  │  │               │  │  - 目录操作   │  │  - 增量更新                │  │ │  │  │
│  │  │  │  │               │  │  - 权限管理   │  │  - 热更新/重启             │  │ │  │  │
│  │  │  │  │               │  │               │  │  - 回滚机制                │  │ │  │  │
│  │  │  │  └───────────────┘  └───────────────┘  └─────────────────────────────┘  │ │  │  │
│  │  │  │                                                                          │ │  │  │
│  │  │  │  ┌───────────────────────────────────────────────────────────────────┐  │ │  │  │
│  │  │  │  │                     心跳/状态上报                                  │  │ │  │  │
│  │  │  │  └───────────────────────────────────────────────────────────────────┘  │ │  │  │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘ │  │  │
│  │  │                                                                           │  │  │
│  │  │                        ... 更多 Sandbox ...                                │  │  │
│  │  │                                                                           │  │  │
│  │  └───────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                    │  │
│  └──────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心子系统

| 编号 | 子系统 | 描述 | 位置 |
|------|--------|------|------|
| 1 | **CLI 子系统** | 命令行管理工具 | 控制平面 |
| 2 | **SDK 子系统** | 客户端 SDK | 控制平面 |
| 3 | **Server 子系统** | HTTP API 服务 | 控制平面 |
| 4 | **Runner 子系统** | 容器编排引擎 | 编排平面 |
| 5 | **Agent 子系统** | 容器内代理 | 沙盒平面 |
| 6 | **通信子系统** | gRPC 协议 + mTLS + 隧道 | 全局 |
| 7 | **存储子系统** | 卷与快照管理 | 编排平面 |
| 8 | **认证子系统** | 身份认证与授权 | 全局 |

## 2. 子系统详细设计

### 2.1 CLI 子系统

```
┌─────────────────────────────────────────────────────────┐
│                    CLI 子系统                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  命令层                           │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌──────┐ │   │
│  │  │ create  │ │ delete  │ │  list   │ │ ssh  │ │   │
│  │  │ create  │ │ delete  │ │  list   │ │ ssh  │ │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └──────┘ │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌──────┐ │   │
│  │  │ status  │ │  logs   │ │snapshot │ │ exec │ │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └──────┘ │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  业务层                           │   │
│  │  ┌─────────────┐  ┌─────────────┐               │   │
│  │  │ SandboxMgr  │  │  ConfigMgr  │               │   │
│  │  │ - CRUD 操作 │  │ - 端点配置  │               │   │
│  │  │ - 状态查询  │  │ - 认证配置  │               │   │
│  │  └─────────────┘  └─────────────┘               │   │
│  │  ┌─────────────┐  ┌─────────────┐               │   │
│  │  │  SSH 客户端 │  │  执行器      │               │   │
│  │  │ - 连接管理 │  │ - 命令执行  │               │   │
│  │  │ - 会话管理 │  │ - 管道处理  │               │   │
│  │  └─────────────┘  └─────────────┘               │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  通信层                           │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │         REST Client (HTTP)              │   │   │
│  │  │         SSH Client (SSH)                │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**命令列表:**

| 命令 | 描述 |
|------|------|
| `codepod create` | 创建 Sandbox |
| `codepod delete` | 删除 Sandbox |
| `codepod list` | 列出所有 Sandbox |
| `codepod status` | 查看 Sandbox 状态 |
| `codepod logs` | 查看日志 |
| `codepod ssh` | SSH 连接 |
| `codepod exec` | 执行命令 |
| `codepod snapshot create` | 创建快照 |
| `codepod snapshot restore` | 恢复快照 |
| `codepod snapshot list` | 列出快照 |
| `codepod config` | 配置管理 |

**Server 连接配置:**

CLI/SDK 与 Server 部署在不同机器上，通过 HTTP 进行通信：

```
┌─────────────────────────────────────────────────────────┐
│              CLI/SDK 连接 Server                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │              首次连接配置                          │   │
│  │                                                  │   │
│  │  # 方式 1: 通过 Server UI 获取配置               │   │
│  │  # 访问 Server Web 界面，获取:                  │   │
│  │  # - Server URL: https://codepod.example.com  │   │
│  │  # - API Key: cp_live_xxxx                    │   │
│  │                                                  │   │
│  │  # 方式 2: 命令行配置                           │   │
│  │  codepod config set endpoint https://codepod.example.com│   │
│  │  codepod config set api-key cp_live_xxxx      │   │
│  │                                                  │   │
│  │  # 方式 3: 配置文件                             │   │
│  │  # ~/.codepod/config.yaml:                    │   │
│  │  # endpoint: https://codepod.example.com      │   │
│  │  # api_key: cp_live_xxxx                      │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

**HTTP API 通信:**

```
┌─────────────────────────────────────────────────────────┐
│              HTTP API 通信                                │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Sandbox 管理操作                       │   │
│  │                                                  │   │
│  │  CLI/SDK ──HTTP POST──► Server                  │   │
│  │     │                                              │   │
│  │     │  POST /api/v1/sandboxes                  │   │
│  │     │  { type, image, resources, ... }         │   │
│  │     │                                              │   │
│  │     ◄──HTTP 201 Created──                       │   │
│  │          { id, ssh: { host, port, user }, ... }│   │
│  │                                                  │   │
│  │  CLI/SDK ──HTTP DELETE──► Server               │   │
│  │     │                                              │   │
│  │     │  DELETE /api/v1/sandboxes/:id           │   │
│  │     │                                              │   │
│  │     ◄──HTTP 204 No Content──                   │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │              SSH 连接流程                          │   │
│  │                                                  │   │
│  │  1. 查询 Sandbox 信息并获取 SSH Token            │   │
│  │     CLI ──HTTP GET──► Server                   │   │
│  │        │                                        │   │
│  │        │  GET /api/v1/sandboxes/:id/ssh       │   │
│  │        │                                        │   │
│  │        ◄──HTTP 200 OK──                       │   │
│  │            { host, port, user, token }        │   │
│  │                                                  │   │
│  │  2. 使用 Token 进行 SSH 连接                    │   │
│  │     CLI ──SSH──► Agent                        │   │
│  │        │   -o "PasswordAuthentication=no"     │   │
│  │        │   -o "PreferredAuthentications=password"│   │
│  │        │   root@host:port (password = token)  │   │
│  │        │                                        │   │
│  │        ◄──SSH Session──                        │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

**SSH 连接详细流程:**

```
┌─────────────────────────────────────────────────────────┐
│              SSH 连接流程 (Token 认证)                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  步骤 1: 获取 SSH Token                                │
│  ┌─────────────────────────────────────────────────┐   │
│  │                                                  │   │
│  │  $ codepod ssh abc123                          │   │
│  │                                                  │   │
│  │  CLI ──HTTP GET /api/v1/sandboxes/abc123/ssh─►│   │
│  │     │                                            │   │
│  │     │  Headers: Authorization: Bearer <api-key>│   │
│  │     │                                            │   │
│  │     ◄──HTTP 200 OK──                          │   │
│  │          {                                      │   │
│  │            "host": "localhost",                │   │
│  │            "port": 2222,                       │   │
│  │            "user": "root",                     │   │
│  │            "token": "cp_token_xxxxx",         │   │
│  │            "expires_in": 3600                 │   │
│  │          }                                     │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  步骤 2: SSH 连接到 Sandbox                            │
│  ┌─────────────────────────────────────────────────┐   │
│  │                                                  │   │
│  │  $ ssh -p 2222 root@localhost                 │   │
│  │     # 输入 Token 作为密码                      │   │
│  │                                                  │   │
│  │  或者 (推荐): 使用 SSHpass                      │   │
│  │  $ sshpass -p "<token>" ssh -p 2222 root@localhost│   │
│  │                                                  │   │
│  │  或者 (配置 SSH config):                       │   │
│  │  # ~/.ssh/config:                             │   │
│  │  Host codepod-abc123                          │   │
│  │      HostName localhost                        │   │
│  │      Port 2222                                │   │
│  │      User root                                 │   │
│  │      ProxyCommand codepod ssh-proxy %h %p    │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  步骤 3: Token 验证                                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │                                                  │   │
│  │  Agent ──验证 Token──►                         │   │
│  │     - 检查 Token 有效性                        │   │
│  │     - 检查 Token 过期时间                      │   │
│  │     - 验证通过，启动 Shell                     │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

**API 接口列表:**

| 方法 | 路径 | 说明 |
|------|------|------|
| `POST` | `/api/v1/sandboxes` | 创建 Sandbox |
| `GET` | `/api/v1/sandboxes` | 列出 Sandbox |
| `GET` | `/api/v1/sandboxes/:id` | 获取 Sandbox 详情 |
| `DELETE` | `/api/v1/sandboxes/:id` | 删除 Sandbox |
| `GET` | `/api/v1/sandboxes/:id/ssh` | 获取 SSH 连接信息 + Token |
| `POST` | `/api/v1/sandboxes/:id/snapshots` | 创建快照 |
| `POST` | `/api/v1/sandboxes/:id/snapshots/:snapId/restore` | 恢复快照 |

### 2.2 SDK 子系统

```
┌─────────────────────────────────────────────────────────┐
│                    SDK 子系统                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  开发者 API                      │   │
│  │                                                  │   │
│  │  import { CodePod } from '@codepod/sdk';        │   │
│  │                                                  │   │
│  │  const pod = new CodePod({                      │   │
│  │    endpoint: 'https://api.codepod.io',         │   │
│  │    token: 'xxx'                                 │   │
│  │  });                                            │   │
│  │                                                  │   │
│  │  await pod.createSandbox({...});                │   │
│  │  await pod.runCode({...});                      │   │
│  │  await pod.createSnapshot({...});               │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  核心模块                         │   │
│  │  ┌─────────────┐  ┌─────────────┐               │   │
│  │  │ CodePod     │  │  Sandbox    │               │   │
│  │  │ - 主客户端  │  │ - 实例管理  │               │   │
│  │  │ - 配置      │  │ - 状态      │               │   │
│  │  └─────────────┘  └─────────────┘               │   │
│  │  ┌─────────────┐  ┌─────────────┐               │   │
│  │  │ SSHClient   │  │  Executor   │               │   │
│  │  │ - 连接      │  │ - 代码执行  │               │   │
│  │  │ - 会话      │  │ - 结果获取  │               │   │
│  │  └─────────────┘  └─────────────┘               │   │
│  │  ┌─────────────┐  ┌─────────────┐               │   │
│  │  │ SnapshotMgr │  │  VolumeMgr   │               │   │
│  │  │ - 快照管理  │  │ - 卷管理    │               │   │
│  │  └─────────────┘  └─────────────┘               │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  传输层                           │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │  REST Client  │  WebSocket Client       │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**SDK 核心接口:**

```typescript
// 主客户端
class CodePod {
  constructor(config: CodePodConfig);
  createSandbox(options: CreateSandboxOptions): Promise<Sandbox>;
  listSandboxes(): Promise<Sandbox[]>;
  getSandbox(id: string): Promise<Sandbox>;
  deleteSandbox(id: string): Promise<void>;
}

// 沙盒实例
class Sandbox {
  id: string;
  status: SandboxStatus;
  ssh: SSHConnection;

  exec(command: string): Promise<ExecResult>;
  createSnapshot(options: SnapshotOptions): Promise<Snapshot>;
  restoreSnapshot(snapshotId: string): Promise<void>;
  getLogs(): Promise<string>;
}

// 代码执行
class Executor {
  runCode(options: RunCodeOptions): Promise<ExecutionResult>;
  startSession(language: string): Promise<Session>;
  executeInSession(sessionId: string, code: string): Promise<ExecutionResult>;
}
```

### 2.3 Server 子系统

```
┌─────────────────────────────────────────────────────────┐
│                    Server 子系统                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  API 路由层                        │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │              /api/v1                    │   │   │
│  │  │  ┌───────────┐ ┌───────────┐          │   │   │
│  │  │  │ /sandboxes │ │ /snapshots│          │   │   │
│  │  │  │ - POST    │ │ - POST   │          │   │   │
│  │  │  │ - GET     │ │ - GET    │          │   │   │
│  │  │  │ - DELETE  │ │ - DELETE │          │   │   │
│  │  │  └───────────┘ └───────────┘          │   │   │
│  │  │  ┌───────────┐ ┌───────────┐          │   │   │
│  │  │  │ /exec     │ │ /health   │          │   │   │
│  │  │  │ - POST   │ │ - GET    │          │   │   │
│  │  │  └───────────┘ └───────────┘          │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  业务逻辑层                      │   │
│  │                                                  │   │
│  │  ┌───────────────────┐  ┌────────────────────┐  │   │
│  │  │  SandboxService   │  │  RunnerService    │  │   │
│  │  │  - 创建/删除/查询 │  │  - Runner 注册    │  │   │
│  │  │  - 状态管理       │  │  - 任务下发       │  │   │
│  │  │  - 资源配额       │  │  - 状态同步       │  │   │
│  │  └───────────────────┘  └────────────────────┘  │   │
│  │  ┌───────────────────┐  ┌────────────────────┐  │   │
│  │  │  SnapshotService  │  │  AuthService      │  │   │
│  │  │  - 快照管理       │  │  - Token 验证     │  │   │
│  │  │  - 恢复/克隆      │  │  - 权限检查       │  │   │
│  │  └───────────────────┘  └────────────────────┘  │   │
│  │  ┌───────────────────┐  ┌────────────────────┐  │   │
│  │  │  AuditService     │  │  ConfigService    │  │   │
│  │  │  - 操作日志       │  │  - 系统配置       │  │   │
│  │  │  - 审计查询       │  │  - Agent 版本     │  │   │
│  │  └───────────────────┘  └────────────────────┘  │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  数据访问层                       │   │
│  │  ┌─────────────┐  ┌─────────────┐               │   │
│  │  │  SQLite     │  │   Redis     │               │   │
│  │  │ - Sandbox  │  │ - 任务队列  │               │   │
│  │  │ - Snapshot │  │ - 会话缓存  │               │   │
│  │  │ - 配置      │  │ - 限流      │               │   │
│  │  └─────────────┘  └─────────────┘               │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  通信层                           │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │   HTTP Server   │   gRPC Server        │   │   │
│  │  │   (Express)     │   (用户 API)         │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2.4 Runner 子系统

```
┌─────────────────────────────────────────────────────────┐
│                    Runner 子系统                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  任务调度层                       │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │              Job Queue                   │   │   │
│  │  │  ┌───────────┐ ┌───────────┐            │   │   │
│  │  │  │ CreateJob │ │ DeleteJob │            │   │   │
│  │  │  │ UpdateJob │ │ QueryJob  │            │   │   │
│  │  │  └───────────┘ └───────────┘            │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │              状态机                       │   │   │
│  │  │  ┌─────┐  ┌──────┐  ┌───────┐          │   │   │
│  │  │  │pending│►│running│►│running │          │   │   │
│  │  │  └─────┘  └──────┘  └───────┘          │   │   │
│  │  │                  │         │            │   │   │
│  │  │                  ▼         ▼            │   │   │
│  │  │              ┌───────┐ ┌──────┐         │   │   │
│  │  │              │success ││failed │         │   │   │
│  │  │              └───────┘ └──────┘         │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  Docker 操作层                     │   │
│  │                                                  │   │
│  │  ┌───────────────────┐  ┌────────────────────┐  │   │
│  │  │  ImageManager     │  │  ContainerManager  │  │   │
│  │  │  - 镜像拉取       │  │  - 容器创建        │  │   │
│  │  │  - 镜像构建       │  │  - 容器启动/停止   │  │   │
│  │  │  - 镜像缓存       │  │  - 容器删除        │  │   │
│  │  │  - 安全扫描       │  │  - 资源限制        │  │   │
│  │  └───────────────────┘  └────────────────────┘  │   │
│  │  ┌───────────────────┐  ┌────────────────────┐  │   │
│  │  │  NetworkManager   │  │  SecurityManager   │  │   │
│  │  │  - 网络创建        │  │  - seccomp         │  │   │
│  │  │  - 端口映射        │  │  - capabilities   │  │   │
│  │  │  - DNS 配置        │  │  - 用户命名空间    │  │   │
│  │  └───────────────────┘  └────────────────────┘  │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  存储管理层                         │   │
│  │  ┌───────────────────┐  ┌────────────────────┐  │   │
│  │  │  VolumeManager   │  │  SnapshotManager   │  │   │
│  │  │  - 卷创建/删除   │  │  - 创建快照        │  │   │
│  │  │  - 卷挂载        │  │  - 恢复快照        │  │   │
│  │  │  - 只读挂载      │  │  - 克隆快照        │  │   │
│  │  └───────────────────┘  └────────────────────┘  │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  Agent 管理层                      │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │  - Agent 版本管理                        │   │   │
│  │  │  - Agent 注入 (通过 Entrypoint)         │   │   │
│  │  │  - Agent 状态监控                       │   │   │
│  │  │  - Agent 更新下发                        │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  **部署模式:**                                           │
│  - Docker (DinD): 容器内运行 Docker，创建 Sandbox 容器 │
│  - Kubernetes: 作为独立 Pod 运行，通过 Docker Socket 连接    │
│  - 弹性伸缩: 支持 HPA/VPA 自动扩缩容                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2.5 Agent 子系统

```
┌─────────────────────────────────────────────────────────┐
│                    Agent 子系统                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  PID 1 进程                                             │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  SSH Server                     │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           会话管理器                      │   │   │
│  │  │  ┌───────────┐ ┌───────────┐            │   │   │
│  │  │  │ Interactive│ │ Non-Interact│          │   │   │
│  │  │  │ Session   │ │ Session    │            │   │   │
│  │  │  └───────────┘ └───────────┘            │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           认证管理器                      │   │   │
│  │  │  - 公钥认证 (authorized_keys)            │   │   │
│  │  │  - Token 认证                            │   │   │
│  │  │  - 密码认证                              │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           端口转发管理器                  │   │   │
│  │  │  - 本地端口转发 (-L)                     │   │   │
│  │  │  - 远程端口转发 (-R)                     │   │   │
│  │  │  - 动态端口转发 (-D)                     │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  进程管理器                       │   │
│  │                                                  │   │
│  │  ┌───────────────────┐  ┌────────────────────┐  │   │
│  │  │  子进程管理       │  │  信号处理          │  │   │
│  │  │  - fork/exec    │  │  - SIGTERM         │  │   │
│  │  │  - wait/waitpid │  │  - SIGKILL         │  │   │
│  │  │  - zombie 回收  │  │  - SIGINT          │  │   │
│  │  │  - 进程组管理   │  │  - 信号转发        │  │   │
│  │  └───────────────────┘  └────────────────────┘  │   │
│  │  ┌───────────────────┐  ┌────────────────────┐  │   │
│  │  │  资源限制         │  │  Cgroup 管理       │  │   │
│  │  │  - CPU 限制      │  │  - cpu.shares      │  │   │
│  │  │  - 内存限制      │  │  - memory.limit    │  │   │
│  │  │  - 进程数限制    │  │  - pids.limit      │  │   │
│  │  └───────────────────┘  └────────────────────┘  │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  命令执行器                        │   │
│  │                                                  │   │
│  │  ┌───────────────────┐  ┌────────────────────┐  │   │
│  │  │  Shell 执行器    │  │  直接执行器        │  │   │
│  │  │  - bash/sh       │  │  - exec syscall   │  │   │
│  │  │  - 管道/重定向  │  │  - 管道处理        │  │   │
│  │  │  - 环境变量     │  │  - 环境变量        │  │   │
│  │  │  - Tab 补全     │  │  - 工作目录        │  │   │
│  │  └───────────────────┘  └────────────────────┘  │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           PTY 管理                        │   │   │
│  │  │  - 终端分配 (pts)                        │   │   │
│  │  │  - 窗口大小 (resize)                     │   │   │
│  │  │  - 原始模式/cook 模式                   │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  文件管理器                        │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │  - SFTP 子系统                          │   │   │
│  │  │  - 文件上传/下载                        │   │   │
│  │  │  - 目录操作 (mkdir/rm/cp/mv)           │   │   │
│  │  │  - 权限管理 (chmod/chown)              │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  状态上报                         │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │  - 心跳 (gRPC)                          │   │   │
│  │  │  - 资源使用 (CPU/Memory/Disk)          │   │   │
│  │  │  - 进程列表                             │   │   │
│  │  │  - 连接状态                             │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  更新模块                          │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │  - 版本检测 (从 Server 获取)             │   │   │
│  │  │  - 增量更新 (差分下载)                  │   │   │
│  │  │  - 签名验证                             │   │   │
│  │  │  - 热更新 / 重启                        │   │   │
│  │  │  - 回滚机制                             │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2.6 通信子系统

```
┌─────────────────────────────────────────────────────────┐
│                    通信子系统                             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Server ◄─────► Runner               │   │
│  │                                                  │   │
│  │              gRPC over TLS (mTLS)              │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           双向流 (Bi-directional)        │   │   │
│  │  │                                          │   │   │
│  │  │  Runner ────►  心跳流 ◄─── Server       │   │   │
│  │  │  Runner ◄───►  任务流 ◄─── Server       │   │   │
│  │  │  Runner ────►  日志流 ◄─── Server       │   │   │
│  │  │                                          │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│                        │ 反向隧道 (Runner 发起)           │
│                        ▼                                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Runner ◄──► Server                  │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │            网络穿透                       │   │   │
│  │  │  Runner 启动 ──► 主动连接 Server        │   │   │
│  │  │                 │                        │   │   │
│  │  │                 ▼                        │   │   │
│  │  │           建立反向隧道                   │   │   │
│  │  │                 │                        │   │   │
│  │  │                 ▼                        │   │   │
│  │  │       Server 可下发指令给 Runner        │   │   │
│  │  │                                          │   │   │
│  │  │  ┌───────────────────────────────────┐ │   │   │
│  │  │  │  可选: Tailscale/Wireguard Mesh   │ │   │   │
│  │  │  │  构建 Overlay VPN 网络              │ │   │   │
│  │  │  └───────────────────────────────────┘ │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                   mTLS 认证                      │   │
│  │                                                  │   │
│  │  ┌──────────┐                    ┌──────────┐   │   │
│  │  │  Server  │◄─── 双向 TLS ───►│  Runner  │   │   │
│  │  │  证书    │     证书验证      │  证书    │   │   │
│  │  └──────────┘                    └──────────┘   │   │
│  │                                                  │   │
│  │  - 双向认证                                       │   │
│  │  - 证书过期自动轮换                               │   │
│  │  - 证书吊销检查                                   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2.7 存储子系统

```
┌─────────────────────────────────────────────────────────┐
│                    存储子系统                             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                   卷管理                         │   │
│  │                                                  │   │
│  │  ┌───────────────┐  ┌───────────────┐          │   │
│  │  │  绑定挂载      │  │   命名卷       │          │   │
│  │  │               │  │               │          │   │
│  │  │  主机目录      │  │  Docker Vol   │          │   │
│  │  │  /data/code   │  │  codepod_xxx  │          │   │
│  │  │               │  │               │          │   │
│  │  └───────────────┘  └───────────────┘          │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           只读挂载                        │   │   │
│  │  │                                          │   │   │
│  │  │  模板/依赖库 ──► 容器内只读挂载          │   │   │
│  │  │                                          │   │   │
│  │  │  ro=true, bind, recurse=false            │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           临时卷 (tmpfs)                 │   │   │
│  │  │                                          │   │   │
│  │  │  容器内 /tmp 目录，内存存储              │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │                  快照管理                         │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           快照类型                        │   │   │
│  │  │                                          │   │   │
│  │  │  ┌───────────┐  ┌───────────┐           │   │   │
│  │  │  │ 全量快照  │  │ 增量快照  │           │   │   │
│  │  │  │ Docker    │  │  Copy-on- │           │   │   │
│  │  │  │ Commit    │  │ Write     │           │   │   │
│  │  │  └───────────┘  └───────────┘           │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           快照操作                        │   │   │
│  │  │                                          │   │   │
│  │  │  创建 ──► 列出 ──► 恢复 ──► 克隆 ──► 删除 │   │   │
│  │  │                                          │   │   │
│  │  │  ┌───────────────────────────────────┐ │   │   │
│  │  │  │  元数据存储 (Server 端)            │ │   │   │
│  │  │  │  - 快照名称                         │ │   │   │
│  │  │  │  - 创建时间                         │ │   │   │
│  │  │  │  - 镜像 ID                         │ │   │   │
│  │  │  │  - 描述                            │ │   │   │
│  │  │  └───────────────────────────────────┘ │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2.8 网络与 DNS 子系统

#### 2.8.1 DNS 模式概述

CodePod 支持两种 DNS 模式：

| 模式 | 描述 | 优先级 |
|------|------|--------|
| **无域名模式** | 内嵌 DNS 服务器，独立的 `.local` 域名 | 优先 |
| **有域名模式** | 集成已有域名体系 (企业 DNS / 云 DNS) | 后续 |

---

#### 2.8.2 无域名模式（优先支持）

**概述：** 使用内嵌 DNS 服务器 (CoreDNS)，提供独立的域名解析服务。

**域名格式：**
```
{sandbox-id}.{workspace}.codepod.local
```

**示例：**
- `abc123.dev.codepod.local`
- `xyz789.prod.codepod.local`

**架构：**

```
┌─────────────────────────────────────────────────────────┐
│              无域名模式 - 本地访问                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  本地电脑                         │   │
│  │                                                  │   │
│  │  方案 1: 修改 hosts 文件                        │   │
│  │  127.0.0.1 abc123.dev.codepod.local          │   │
│  │  127.0.0.1 *.codepod.local                    │   │
│  │                                                  │   │
│  │  方案 2: 配置系统 DNS (推荐)                   │   │
│  │  将 codepod.local 解析到 CodePod Server        │   │
│  │                                                  │   │
│  │  访问:                                          │   │
│  │  ssh abc123.dev.codepod.local -p 2222         │   │
│  │                                                  │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│                        │ HTTP/SSH                        │
│                        ▼                                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │              CodePod Server                      │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           内嵌 DNS 服务器 (CoreDNS)        │   │   │
│  │  │                                        │   │   │
│  │  │  abc123.dev.codepod.local -> 172.17.0.2│   │   │
│  │  │  xyz789.dev.codepod.local -> 172.17.0.3│   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│                        ▼                                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Docker 网络 (codepod-net)            │   │
│  │                                                  │   │
│  │  ┌──────────────┐  ┌──────────────┐            │   │
│  │  │ Sandbox A   │  │ Sandbox B   │            │   │
│  │  │ 172.17.0.2  │◄─►│ 172.17.0.3  │            │   │
│  │  │ abc123.dev  │  │ xyz789.dev  │            │   │
│  │  └──────────────┘  └──────────────┘            │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**Sandbox 间通信：**

```
Sandbox A (abc123.dev) ──► curl http://xyz789.dev.codepod.local:8080
                                │
                                │ DNS 解析
                                ▼
                        172.17.0.3 ──► Sandbox B
```

**DNS 服务功能：**
- 动态域名注册 (Sandbox 创建时自动添加)
- 域名解析 (A/CNAME 记录)
- 健康检查 (检测 Sandbox 状态)
- TTL 管理
- 自动清理过期记录

---

#### 2.8.3 有域名模式（后续支持）

**概述：** 集成企业已有 DNS 或云 DNS 服务。

**域名格式：**
```
{sandbox-id}.{workspace}.{custom-domain}
```

**示例：**
- `abc123.dev.example.com`
- `xyz789.prod.company.internal`

**集成方式：**

| 方式 | 描述 |
|------|------|
| DNS API | AWS Route53、CloudFlare、阿里云 DNS 等 |
| nsupdate | 动态 DNS 更新协议 |
| DNS 转发 | 转发特定域名到 CodePod DNS |
| CNAME 代理 | 使用 CNAME 指向内部域名 |

**架构：**

```
┌─────────────────────────────────────────────────────────┐
│              有域名模式 - 架构                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  用户域名服务器                    │   │
│  │              (企业 DNS / 云 DNS)                │   │
│  │                                                  │   │
│  │  example.com zone:                             │   │
│  │  - abc123.dev.example.com -> 10.0.0.50       │   │
│  │  - xyz789.prod.example.com -> 10.0.0.51      │   │
│  │                                                  │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│                        │ DNS 动态更新                   │
│                        │ (nsupdate / API)              │
│                        ▼                                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │              CodePod Server                      │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           DNS 客户端                      │   │   │
│  │  │  - 注册域名                              │   │   │
│  │  │  - 同步记录                              │   │   │
│  │  │  - 健康检查                              │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│                        ▼                                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Docker 网络                          │   │
│  │  ┌──────────────┐  ┌──────────────┐            │   │
│  │  │ Sandbox A   │  │ Sandbox B   │            │   │
│  │  │ 10.0.0.50   │◄─►│ 10.0.0.51   │            │   │
│  │  └──────────────┘  └──────────────┘            │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

#### 2.8.4 网络管理

**网络隔离模式：**

| 模式 | 描述 | Sandbox 间通信 |
|------|------|----------------|
| 隔离模式 | 独立网络 | 不可达 |
| 共享模式 | 同一网络 | 通过域名互通 |
| 自定义模式 | 指定网络 | 按配置 |

**端口映射：**
- 主机端口映射
- 动态端口分配
- 端口范围管理

---

#### 2.8.5 域名配置示例

```yaml
# 无域名模式 (默认，优先支持)
{
  "type": "dev-container",
  "workspace": "dev",
  "domain": {
    "mode": "builtin",           # 内嵌 DNS
    "suffix": "codepod.local"   # 默认后缀
  },
  "network": {
    "mode": "shared"
  }
}
# 域名: abc123.dev.codepod.local

# 有域名模式 (后续支持)
{
  "type": "dev-container",
  "workspace": "prod",
  "domain": {
    "mode": "custom",           # 自定义 DNS
    "provider": "route53",      # DNS 提供商
    "suffix": "example.com"     # 域名后缀
  },
  "network": {
    "mode": "shared"
  }
}
# 域名: abc123.prod.example.com
```

### 2.9 认证子系统

```
┌─────────────────────────────────────────────────────────┐
│                    认证子系统                             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                   认证流程                       │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │         CLI/SDK ──► Server               │   │   │
│  │  │                                          │   │   │
│  │  │  1. 登录获取 Token                       │   │   │
│  │  │     POST /api/v1/auth/login            │   │   │
│  │  │     { username, password }              │   │   │
│  │  │                                          │   │   │
│  │  │  2. 获取访问 Token                       │   │   │
│  │  │     { access_token, refresh_token }     │   │   │
│  │  │                                          │   │   │
│  │  │  3. 使用 Token 访问 API                  │   │   │
│  │  │     Authorization: Bearer <token>       │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │    SSH 连接 ──► Agent                    │   │   │
│  │  │                                          │   │   │
│  │  │  方式 1: Token 认证                       │   │   │
│  │  │  - 使用 SDK 获取临时 SSH 凭证            │   │   │
│  │  │  - Token 作为密码或密钥                  │   │   │
│  │  │                                          │   │   │
│  │  │  方式 2: 公钥认证                         │   │   │
│  │  │  - 用户配置 authorized_keys             │   │   │
│  │  │  - VSCode Remote SSH 持久连接           │   │   │
│  │  │                                          │   │   │
│  │  │  方式 3: 密码认证                         │   │   │
│  │  │  - 临时密码或固定密码                   │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│                        ▼                                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │              API Key 管理                          │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           API Key 特性                     │   │   │
│  │  │                                        │   │   │
│  │  │  - 格式: cp_live_xxxx / cp_test_xxxx   │   │   │
│  │  │  - 用途: CLI/SDK 认证                    │   │   │
│  │  │  - 权限: 按 API Key 绑定                │   │   │
│  │  │  - 过期: 可设置过期时间                 │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           API 管理接口                    │   │   │
│  │  │                                        │   │   │
│  │  │  POST   /api/v1/keys         创建 API Key   │   │
│  │  │  GET    /api/v1/keys         列出 API Key   │   │
│  │  │  DELETE /api/v1/keys/:id     删除 API Key   │   │
│  │  │  POST   /api/v1/keys/:id/rotate  轮换 API Key│   │
│  │  │  PUT    /api/v1/keys/:id     更新 API Key   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           轮换场景                         │   │   │
│  │  │                                        │   │   │
│  │  │  场景 1: API Key 泄露                   │   │   │
│  │  │  - 立即禁用泄露的 Key                   │   │   │
│  │  │  - 创建新的 Key                         │   │   │
│  │  │  - 分发新 Key 给用户                    │   │   │
│  │  │                                        │   │   │
│  │  │  场景 2: 定期轮换                       │   │   │
│  │  │  - 设置过期时间 (30/60/90 天)           │   │   │
│  │  │  - 提前提醒用户                        │   │   │
│  │  │  - 自动轮换                            │   │   │
│  │  │                                        │   │   │
│  │  │  场景 3: 批量管理                       │   │   │
│  │  │  - 批量创建 Key                        │   │   │
│  │  │  - 批量禁用 Key                        │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           API Key 响应示例                │   │   │
│  │  │                                        │   │   │
│  │  │  POST /api/v1/keys                     │   │   │
│  │  │  {                                     │   │   │
│  │  │    "name": "dev-key",                 │   │   │
│  │  │    "expires_in": 86400,               │   │   │
│  │  │    "permissions": ["read", "write"]   │   │   │
│  │  │  }                                     │   │   │
│  │  │                                        │   │   │
│  │  │  Response:                             │   │   │
│  │  │  {                                     │   │   │
│  │  │    "id": "key_abc123",               │   │   │
│  │  │    "key": "cp_live_xxxxxxxx",       │   │   │
│  │  │    "name": "dev-key",                │   │   │
│  │  │    "created_at": "2026-02-17T00:00:00Z",│   │   │
│  │  │    "expires_at": "2026-02-18T00:00:00Z",│   │   │
│  │  │    "status": "active"                │   │   │
│  │  │  }                                     │   │   │
│  │  │                                        │   │   │
│  │  │  ⚠️ 注意: key 只在创建时返回一次           │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│                        ▼                                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │                   授权模型                       │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │         RBAC (基于角色)                   │   │   │
│  │  │                                          │   │   │
│  │  │  ┌───────────┐  ┌───────────┐           │   │   │
│  │  │  │  Admin   │  │  User    │           │   │   │
│  │  │  │ - 所有权限│  │ - 自己创建 │          │   │   │
│  │  │  └───────────┘  └───────────┘           │   │   │
│  │  │                                          │   │   │
│  │  │  ┌───────────┐  ┌───────────┐           │   │   │
│  │  │  │ Developer│  │ Viewer   │           │   │   │
│  │  │  │ - 读写   │  │ - 只读   │           │   │   │
│  │  │  └───────────┘  └───────────┘           │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │         资源级别权限                     │   │   │
│  │  │                                          │   │   │
│  │  │  - Sandbox 所有者可管理自己的 Sandbox   │   │   │
│  │  │  - 可配置共享访问                        │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                   证书管理                       │   │
│  │                                                  │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │         mTLS 证书 (Server-Runner)         │   │   │
│  │  │                                          │   │   │
│  │  │  - Server 证书 (服务端认证)              │   │   │
│  │  │  - Runner 证书 (客户端认证)              │   │   │
│  │  │  - 证书签发 (CA)                        │   │   │
│  │  │  - 证书轮换                             │   │   │
│  │  │  - 证书吊销列表 (CRL)                   │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 3. 子系统间交互接口

### 3.1 交互矩阵

```
┌────────────┬──────┬──────┬───────┬───────┬──────┬──────┬───────┬──────┐
│            │ CLI  │ SDK  │Server │Runner │ Agent│ 通信 │ 存储  │ 认证 │
├────────────┼──────┼──────┼───────┼───────┼──────┼──────┼───────┼──────┤
│ CLI        │  -   │      │ HTTP  │       │ SSH │      │       │ Token│
│ SDK        │      │  -   │ HTTP  │       │ SSH │      │       │ Token│
│ Server     │ HTTP │ HTTP │  -    │ gRPC │     │ gRPC │ Local │ Token│
│ Runner     │      │      │ gRPC  │  -    │HTTP │      │ Docker│ mTLS │
│ Agent      │ SSH  │ SSH  │       │ HTTP │  -  │ gRPC │       │      │
│ 通信       │      │      │ gRPC │ gRPC │gRPC │  -   │       │ mTLS │
│ 存储       │      │      │      │Docker│     │      │  -   │      │
│ 认证       │Token │Token │ Token │ mTLS │     │ mTLS │      │  -   │
└────────────┴──────┴──────┴───────┴───────┴──────┴──────┴───────┴──────┘
```

### 3.2 核心接口定义

#### 3.2.1 CLI/SDK ↔ Server (HTTP API)

```typescript
// Sandbox 管理
interface SandboxAPI {
  // 创建 Sandbox
  createSandbox(req: CreateSandboxRequest): Promise<CreateSandboxResponse>;

  // 获取 Sandbox
  getSandbox(id: string): Promise<Sandbox>;

  // 列出 Sandbox
  listSandboxes(filter?: ListFilter): Promise<Sandbox[]>;

  // 删除 Sandbox
  deleteSandbox(id: string): Promise<void>;

  // 获取 SSH 凭证
  getSSHCredentials(id: string): Promise<SSHCredentials>;
}

// 快照管理
interface SnapshotAPI {
  createSnapshot(req: CreateSnapshotRequest): Promise<Snapshot>;
  listSnapshots(sandboxId: string): Promise<Snapshot[]>;
  restoreSnapshot(sandboxId: string, snapshotId: string): Promise<void>;
  deleteSnapshot(sandboxId: string, snapshotId: string): Promise<void>;
}

// 代码执行
interface ExecAPI {
  runCode(req: RunCodeRequest): Promise<RunCodeResponse>;
  createSession(req: CreateSessionRequest): Promise<Session>;
  executeInSession(sessionId: string, code: string): Promise<ExecutionResult>;
}
```

#### 3.2.2 Server ↔ Runner (gRPC)

```protobuf
// Runner Service
service RunnerService {
  // Runner 注册
  rpc Register(RegisterRequest) returns (RegisterResponse);

  // 心跳
  rpc Heartbeat(stream HeartbeatRequest) returns (stream HeartbeatResponse);

  // 任务处理
  rpc SubmitJob(Job) returns (JobResult);
  rpc GetJobStatus(JobId) returns (JobStatus);

  // 日志流
  rpc SubscribeLogs(LogRequest) returns (stream LogEntry);

  // Agent 管理
  rpc UpdateAgent(UpdateAgentRequest) returns (UpdateAgentResponse);

  // 资源查询
  rpc GetResources(ResourceRequest) returns (Resources);
}

// Sandbox 操作
service SandboxService {
  // 创建 Sandbox
  rpc CreateSandbox(CreateSandboxRequest) returns (SandboxInfo);

  // 删除 Sandbox
  rpc DeleteSandbox(DeleteSandboxRequest) returns (DeleteSandboxResponse);

  // 快照操作
  rpc CreateSnapshot(CreateSnapshotRequest) returns (SnapshotInfo);
  rpc RestoreSnapshot(RestoreSnapshotRequest) returns (RestoreSnapshotResponse);

  // 容器操作
  rpc StartContainer(ContainerRequest) returns (ContainerResponse);
  rpc StopContainer(ContainerRequest) returns (ContainerResponse);
  rpc GetContainerStatus(ContainerId) returns (ContainerStatus);
}
```

#### 3.2.3 Runner ↔ Agent (HTTP)

```typescript
// Agent HTTP API (在容器内运行)
interface AgentAPI {
  // 健康检查
  GET /health → { status: string, version: string }

  // 状态上报
  POST /status → { cpu: number, memory: number, processes: Process[] }

  // 文件操作
  POST /file/read → { path: string } → { content: string }
  POST /file/write → { path: string, content: string } → { success: boolean }
  POST /file/list → { path: string } → { entries: FileEntry[] }

  // 命令执行
  POST /exec → { command: string, env?: Record<string, string> } → { output: string, exitCode: number }

  // 端口转发
  POST /tunnel/create → { type: 'local'|'remote'|'dynamic', ... } → { tunnelId: string }
  DELETE /tunnel/:id → { success: boolean }
}
```

#### 3.2.4 Agent ↔ Runner (gRPC Stream)

```protobuf
// Agent 到 Runner 的通信
service AgentRunnerComm {
  // 状态上报流
  rpc ReportStatus(stream AgentStatus) returns (stream ControlCommand);

  // 日志上传
  rpc UploadLogs(stream LogData) returns (Empty);

  // 心跳
  rpc Ping(Empty) returns (Pong);
}

// 消息类型
message AgentStatus {
  string sandbox_id = 1;
  string agent_version = 2;
  ResourceUsage resources = 3;
  repeated ProcessInfo processes = 4;
  ConnectionInfo connections = 5;
}

message ControlCommand {
  enum CmdType {
    UPDATE_AGENT = 1;
    SHUTDOWN = 2;
    RESTART = 3;
    UPDATE_CONFIG = 4;
  }
  CmdType type = 1;
  bytes payload = 2;
}
```

## 4. 数据流设计

### 4.1 创建 Sandbox 流程

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│   CLI   │     │   SDK   │     │ Server  │     │ Runner  │     │  Agent  │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │               │
     │ create request│               │               │               │
     │──────────────►│               │               │               │
     │               │ HTTP POST    │               │               │
     │               │─────────────►│               │               │
     │               │               │               │               │
     │               │               │ 创建 Job      │               │
     │               │               │─────────────►│               │
     │               │               │               │               │
     │               │               │               │ 拉取镜像     │
     │               │               │               │◄────────────│
     │               │               │               │               │
     │               │               │               │ 创建容器     │
     │               │               │               │─────────────►│
     │               │               │               │               │
     │               │               │               │ Agent 启动   │
     │               │               │               │─────────────►│
     │               │               │               │               │
     │               │               │               │ 心跳/就绪   │
     │               │               │               │◄────────────│
     │               │               │               │               │
     │               │               │  Job 完成    │               │
     │               │               │◄─────────────│               │
     │               │               │               │               │
     │               │  返回 Sandbox 信息            │               │
     │               │◄─────────────│               │               │
     │               │               │               │               │
     │ 返回结果      │               │               │               │
     │◄─────────────│               │               │               │
     │               │               │               │               │
     │ SSH 连接     │               │               │               │
     │─────────────────────────────────────────────────────────────►│
     │               │               │               │               │
```

### 4.2 代码执行流程

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│   SDK   │     │ Server  │     │ Runner  │     │  Agent  │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │
     │ runCode      │               │               │
     │────────────►│               │               │
     │               │               │               │
     │               │ 查找 Sandbox│               │
     │               │ 验证权限    │               │
     │               │─────────────►│               │
     │               │               │               │
     │               │               │ 执行命令     │
     │               │               │─────────────►│
     │               │               │               │
     │               │               │ 命令执行完成 │
     │               │               │◄─────────────│
     │               │               │               │
     │               │ 返回结果    │               │
     │               │◄─────────────│               │
     │               │               │               │
     │ 返回执行结果 │               │               │
     │◄─────────────│               │               │
     │               │               │               │
```

### 4.3 快照创建/恢复流程

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│   CLI   │     │ Server  │     │ Runner  │     │  Agent  │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │
     │ snapshot create              │               │
     │────────────►│               │               │
     │               │               │               │
     │               │ 创建快照 Job │               │
     │               │─────────────►│               │
     │               │               │               │
     │               │               │ 暂停容器     │
     │               │               │─────────────►│
     │               │               │               │
     │               │               │ Docker Commit│
     │               │               │─────────────►│
     │               │               │               │
     │               │               │ 保存镜像     │
     │               │               │◄─────────────│
     │               │               │               │
     │               │               │ 恢复容器状态 │
     │               │               │─────────────►│
     │               │               │               │
     │               │ Job 完成     │               │
     │               │◄─────────────│               │
     │               │               │               │
     │  返回快照信息 │               │               │
     │◄─────────────│               │               │
     │               │               │               │
```

## 5. 安全架构

### 5.1 纵深防御

```
┌─────────────────────────────────────────────────────────┐
│                   安全分层                               │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │  Layer 1: 网络层                                  │   │
│  │  - 网络隔离 (独立的 Docker network)              │   │
│  │  - 防火墙规则                                    │   │
│  │  - VPN/Tunnel 加密                              │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │  Layer 2: 传输层                                  │   │
│  │  - TLS 1.3 加密                                  │   │
│  │  - mTLS 双向认证                                 │   │
│  │  - SSH 加密传输                                  │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┘   │
│  │  Layer 3: 认证授权层                               │   │
│  │  - Token 认证                                      │   │
│  │  - 公钥认证                                        │   │
│  │  - RBAC 权限控制                                  │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │  Layer 4: 容器安全层                             │   │
│  │  - seccomp 限制                                   │   │
│  │  - capabilities drop                             │   │
│  │  - readonly rootfs                                │   │
│  │  - user namespace                                 │   │
│  │  - 资源限制 (cpu/memory/pids)                   │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┘   │
│  │  Layer 5: 应用安全层                              │   │
│  │  - Agent 权限控制                                  │   │
│  │  - 命令白名单                                      │   │
│  │  - 文件系统限制                                    │   │
│  │  - 审计日志                                        │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5.2 威胁模型

| 威胁 | 防护措施 |
|------|----------|
| 未授权访问 | Token + 公钥双认证 |
| 中间人攻击 | mTLS + TLS 1.3 |
| 容器逃逸 | seccomp + capabilities drop + user namespace |
| 资源耗尽 | Cgroup 资源限制 |
| 恶意代码执行 | 命令白名单 + 审计日志 |
| 数据泄露 | 网络隔离 + 只读挂载 |
| 凭证泄露 | 临时 Token + 证书轮换 |

## 6. 部署架构

### 6.1 单机部署 (开发/测试)

```
┌─────────────────────────────────────────────────────────┐
│                   单机部署 (开发/测试)                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                   Host Machine                   │   │
│  │                                                  │   │
│  │  ┌───────────────────────────────────────────┐ │   │
│  │  │              Docker Engine                 │ │   │
│  │  │                                            │ │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐   │ │   │
│  │  │  │ Server  │ │ Runner  │ │ Sandboxes│   │ │   │
│  │  │  │ (Node)  │ │  (Go)   │ │ +Agents  │   │ │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘   │ │   │
│  │  │                                            │ │   │
│  │  │  ┌─────────────────────────────────────┐│ │   │
│  │  │  │  codepod-net (bridge network)      ││ │   │
│  │  │  └─────────────────────────────────────┘│ │   │
│  │  └───────────────────────────────────────────┘ │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 6.2 Runner 部署模式

Runner 支持两种部署模式，以适应不同的基础设施环境：

#### 6.2.1 Docker 部署模式 (DinD - Docker-in-Docker)

```
┌─────────────────────────────────────────────────────────┐
│            Runner Docker 部署模式 (DinD)                 │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                   Host Machine                    │   │
│  │                                                  │   │
│  │  ┌───────────────────────────────────────────┐ │   │
│  │  │              Docker Engine (Host)         │ │   │
│  │  │                                            │ │   │
│  │  │  ┌─────────────────────────────────────┐│ │   │
│  │  │  │      Runner Container (DinD)       ││ │   │
│  │  │  │                                      ││ │   │
│  │  │  │  ┌───────────────────────────────┐ ││ │   │
│  │  │  │  │     Docker Daemon (dind)     │ ││ │   │
│  │  │  │  │     - docker.sock 挂载        │ ││ │   │
│  │  │  │  │     - privileged 模式         │ ││ │   │
│  │  │  │  │     - /var/run/docker.sock    │ ││ │   │
│  │  │  │  └───────────────────────────────┘ ││ │   │
│  │  │  │                                      ││ │   │
│  │  │  │  ┌───────────────────────────────┐ ││ │   │
│  │  │  │  │         Runner 进程           │ ││ │   │
│  │  │  │  │  - gRPC Server               │ ││ │   │
│  │  │  │  │  - Job 调度器                │ ││ │   │
│  │  │  │  │  - 镜像管理                  │ ││ │   │
│  │  │  │  │  - 容器管理                  │ ││ │   │
│  │  │  │  └───────────────────────────────┘ ││ │   │
│  │  │  │                                      ││ │   │
│  │  │  │  ┌───────────────────────────────┐ ││ │   │
│  │  │  │  │     Sandbox Containers        │ ││ │   │
│  │  │  │  │  (Runner 创建的子容器)        │ ││ │   │
│  │  │  │  └───────────────────────────────┘ ││ │   │
│  │  │  └─────────────────────────────────────┘│ │   │
│  │  │                                            │   │
│  │  └───────────────────────────────────────────┘ │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  DinD 必要条件:                                         │
│  - 容器需要 privileged 模式                             │
│  - 挂载 /var/run/docker.sock                          │
│  - 或者启动内置 dind 守护进程                           │
└─────────────────────────────────────────────────────────┘
```

**DinD 模式特点:**

| 配置项 | 说明 |
|--------|------|
| 挂载方式 | `/var/run/docker.sock` 或 dind 守护进程 |
| 容器权限 | `--privileged` 或特定 capabilities |
| 网络模式 | 共享 host 网络或独立 bridge |
| 存储驱动 | overlay2 (推荐) |

#### 6.2.2 Kubernetes 部署模式

```
┌─────────────────────────────────────────────────────────┐
│            Runner Kubernetes 部署模式                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  K8s Cluster                     │   │
│  │                                                  │   │
│  │  ┌───────────────────────────────────────────┐ │   │
│  │  │            Runner Pod                      │ │   │
│  │  │                                            │ │   │
│  │  │  ┌─────────────────────────────────────┐ │ │   │
│  │  │  │  runner-agent (Sidecar)            │ │ │   │
│  │  │  │  - 与 Server 通信                   │ │ │   │
│  │  │  │  - 心跳上报                         │ │ │   │
│  │  │  └─────────────────────────────────────┘ │ │   │
│  │  │                                            │ │   │
│  │  │  ┌─────────────────────────────────────┐ │ │   │
│  │  │  │  runner-main (主容器)              │ │ │   │
│  │  │  │  - gRPC Server                     │ │ │   │
│  │  │  │  - Job 调度器                      │ │ │   │
│  │  │  │  - Docker Client (连接外部 Docker) │ │ │   │
│  │  │  └─────────────────────────────────────┘ │ │   │
│  │  │                                            │ │   │
│  │  └───────────────────────────────────────────┘ │   │
│  │                                                  │   │
│  │       ▲                                          │   │
│  │       │ Docker Socket                           │   │
│  │       │ (ConfigMap/Secret 挂载)                 │   │
│  │       │                                          │   │
│  │  ┌────┴────────────────────────────────────┐  │   │
│  │  │         Docker DaemonSet/Node           │  │   │
│  │  │     (Runner 通过 TCP 连接外部 Docker)   │  │   │
│  │  └─────────────────────────────────────────┘  │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  K8s 部署特点:                                          │
│  - Runner 作为独立 Pod 运行                            │
│  - 通过 Docker Socket 或 TCP 连接 Docker daemon       │
│  - 支持 K8s 原生调度和资源管理                        │
└─────────────────────────────────────────────────────────┘
```

**K8s 部署模式:**

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| DaemonSet | 每个 Node 一个 Runner | 高密度场景 |
| Deployment | 可弹性伸缩的 Runner 集群 | 需要自动扩缩容 |
| StatefulSet | 有状态 Runner (保留数据) | 需要持久化场景 |

#### 6.2.3 部署模式对比

| 特性 | Docker (DinD) | Kubernetes |
|------|---------------|------------|
| 隔离性 | 容器级隔离 | Pod 级隔离 |
| 资源管理 | 手动配置 | K8s 自动调度 |
| 弹性伸缩 | 手动/脚本 | HPA/VPA |
| 运维复杂度 | 低 | 中等 |
| 适合规模 | 小型/中型 | 中型/大型 |

### 6.3 Runner 弹性伸缩

Runner 支持弹性伸缩以确保性能充足：

```
┌─────────────────────────────────────────────────────────┐
│              Runner 弹性伸缩架构                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  Server (K8s 集群)                │   │
│  │                                                  │   │
│  │  ┌───────────────────────────────────────────┐ │   │
│  │  │           AutoScaler (HPA/VPA)             │ │   │
│  │  │                                            │ │   │
│  │  │  - 任务队列长度                            │ │   │
│  │  │  - Runner CPU/Memory 使用率               │ │   │
│  │  │  - Sandbox 创建请求速率                   │ │   │
│  │  │  - 平均任务等待时间                        │ │   │
│  │  │  - 容器启动延迟                           │ │   │
│  │  └───────────────────────────────────────────┘ │   │
│  │                                                  │   │
│  │  ┌───────────────────────────────────────────┐ │   │
│  │  │           调度策略                          │ │   │
│  │  │                                            │ │   │
│  │  │  - 任务亲和性                              │ │   │
│  │  │  - 资源预留                               │ │   │
│  │  │  - 区域感知                               │ │   │
│  │  │  - 驱逐策略                               │ │   │
│  │  └───────────────────────────────────────────┘ │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                           │                               │
│                           ▼                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Runner Pods 池                      │   │
│  │                                                  │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐          │   │
│  │  │ Runner1 │ │ Runner2 │ │ Runner3 │ ◄── min │   │
│  │  └─────────┘ └─────────┘ └─────────┘          │   │
│  │        │         │         │                    │   │
│  │        ▼         ▼         ▼                    │   │
│  │  ┌───────────────────────────────────────────┐ │   │
│  │  │        ... 弹性扩展 ...                   │ │   │
│  │  └───────────────────────────────────────────┘ │   │
│  │        │         │         │                    │   │
│  │        ▼         ▼         ▼                    │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────┐ │   │
│  │  │ Runner4 │ │ Runner5 │ │ Runner6 │ │ ... │ ◄── max │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────┘ │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 弹性伸缩指标

| 指标 | 阈值 | 动作 |
|------|------|------|
| **任务队列长度** | > 10 | +1 Runner |
| **任务等待时间** | > 30s | +1 Runner |
| **CPU 使用率** | > 80% (持续 2min) | +1 Runner |
| **内存使用率** | > 85% | +1 Runner |
| **容器启动延迟** | > 60s | +1 Runner |
| **CPU 使用率** | < 20% (持续 5min) | -1 Runner |
| **任务队列长度** | 0 (持续 5min) | -1 Runner |

#### 扩缩容策略

```yaml
# K8s HPA 配置示例
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: codepod-runner-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: codepod-runner
  minReplicas: 2
  maxReplicas: 20
  metrics:
    - type: External
      external:
        metric:
          name: runner_task_queue_length
          selector:
            matchLabels:
              runner: codepod
        target:
          type: AverageValue
          averageValue: "10"
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
```

### 6.4 Server 容器化部署

```
┌─────────────────────────────────────────────────────────┐
│              Server 容器化部署                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  K8s Cluster                     │   │
│  │                                                  │   │
│  │  ┌───────────────────────────────────────────┐ │   │
│  │  │            Server Deployment               │ │   │
│  │  │                                            │ │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐   │ │   │
│  │  │  │ Server1 │ │ Server2 │ │ Server3 │   │ │   │
│  │  │  │ (Pod)   │ │ (Pod)   │ │ (Pod)   │   │ │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘   │ │   │
│  │  │                                            │ │   │
│  │  │  ┌─────────────────────────────────────┐ │ │   │
│  │  │  │  ┌─────────┐ ┌─────────┐          │ │ │   │
│  │  │  │  │ Config  │ │ Secrets │          │ │ │   │
│  │  │  │  │  Map    │ │         │          │ │ │   │
│  │  │  │  └─────────┘ └─────────┘          │ │ │   │
│  │  │  └─────────────────────────────────────┘ │ │   │
│  │  └───────────────────────────────────────────┘ │   │
│  │                                                  │   │
│  │  ┌───────────────────────────────────────────┐ │   │
│  │  │               存储层                        │ │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐   │ │   │
│  │  │  │ SQLite  │ │  Redis  │ │  etcd   │   │ │   │
│  │  │  │ (PVC)   │ │ (StatefulSet)│ │(StatefulSet)│ │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘   │ │   │
│  │  └───────────────────────────────────────────┘ │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  Server 部署配置:                                       │
│  - 使用 Deployment + HPA                              │
│  - 配置文件通过 ConfigMap 挂载                         │
│  - 敏感信息通过 Secrets 管理                           │
│  - 状态存储使用 PVC (SQLite/etcd)                    │
│  - 缓存使用 Redis                                      │
└─────────────────────────────────────────────────────────┘
```

### 6.5 分布式部署

```
┌─────────────────────────────────────────────────────────┐
│                   分布式部署 (生产)                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  Load Balancer                   │   │
│  │                   (nginx/haproxy)                │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │                                 │
│  ┌─────────────────────┴───────────────────────────┐   │
│  │              Server Cluster (3+)               │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐           │   │
│  │  │ Server1 │ │ Server2 │ │ Server3 │           │   │
│  │  │(K8s Pod)│ │(K8s Pod)│ │(K8s Pod)│           │   │
│  │  └─────────┘ └─────────┘ └─────────┘           │   │
│  │              │  Redis  │                        │   │
│  │              │  etcd   │                        │   │
│  └──────────────┼─────────┼────────────────────────┘   │
│                 │         │                              │
│                 │ gRPC    │                              │
│        ┌────────┴───┐ ┌───┴────────┐                    │
│        │            │ │            │                    │
│        ▼            ▼ ▼            ▼                    │
│  ┌─────────┐  ┌─────────┐ ┌─────────┐  ┌─────────┐    │
│  │ Runner1 │  │ Runner2 │ │ Runner3 │  │ Runner4 │    │
│  │  (DinD) │  │ (K8s)   │ │ (DinD)  │  │ (K8s)   │    │
│  └────┬────┘  └────┬────┘ └────┬────┘  └────┬────┘    │
│       │            │            │            │           │
│       ▼            ▼            ▼            ▼           │
│  ┌─────────┐  ┌─────────┐ ┌─────────┐  ┌─────────┐    │
│  │Docker   │  │K8s Pods │ │Docker   │  │K8s Pods │    │
│  │Host 1   │  │         │ │Host 2   │  │         │    │
│  └─────────┘  └─────────┘ └─────────┘  └─────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 7. 监控与运维

### 7.1 监控指标

| 类别 | 指标 | 说明 |
|------|------|------|
| **Server** | 请求延迟 | API 响应时间 |
| **Server** | 请求成功率 | 错误率 |
| **Runner** | 心跳延迟 | Runner 存活检测 |
| **Runner** | 任务队列长度 | 负载指标 |
| **Sandbox** | 创建时间 | 容器启动速度 |
| **Sandbox** | 资源使用 | CPU/Memory/Disk |
| **Sandbox** | 活跃连接数 | SSH 会话数 |

### 7.2 日志架构

```
┌─────────────────────────────────────────────────────────┐
│                   日志收集架构                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  Agent Logs                      │   │
│  │                  (stdout/stderr)                 │   │
│  │                     │                            │   │
│  │                     │ Docker logs               │   │
│  │                     ▼                            │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           Runner Log Aggregator          │   │   │
│  │  │           (filebeat/fluentd)            │   │   │
│  │  └─────────────────────┬───────────────────┘   │   │
│  │                        │                        │   │
│  │                        │ gRPC Stream           │   │
│  │                        ▼                        │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │              Central Log Server          │   │   │
│  │  │              (Elasticsearch)             │   │   │
│  │  └─────────────────────┬───────────────────┘   │   │
│  │                        │                        │   │
│  │                        ▼                        │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │              Kibana / Grafana            │   │   │
│  │  │              (可视化)                    │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 8. 总结

### 8.1 子系统清单

| 编号 | 子系统 | 核心职责 | 关键接口 |
|------|--------|----------|----------|
| 1 | CLI | 命令行管理 | Shell 命令 |
| 2 | SDK | 客户端库 | TypeScript API |
| 3 | Server | HTTP API、任务调度 | REST API |
| 4 | Runner | 容器编排、Docker 操作 | gRPC |
| 5 | Agent | 容器内代理 | SSH + HTTP |
| 6 | 通信 | gRPC + mTLS + 隧道 | Protocol Buffers |
| 7 | 存储 | 卷与快照 | Docker Volume API |
| 8 | 认证 | 身份与授权 | JWT + mTLS |

### 8.2 模块间交互总结

```
CLI/SDK ──HTTP──► Server ──gRPC──► Runner ──Docker──► Sandbox
                              │                    │
                              │                    ▼
                              │              Agent (容器内)
                              │                    │
                              │                    ▼
                              ◄─────────── 心跳/日志
```

---

**这个架构设计是否完整？还需要补充什么？** 确认后我可以继续进行各个子模块的详细设计。
